%
% ixbase-core.sty
%

%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ixbase-core}[2012/05/01 v0.2]

%% preparation
\def\ixbaz@pkgname{ixbase-core}
\def\ixbaz@error{\PackageError\ixbaz@pkgname}
% engine check
\RequirePackage{ifluatex}
\ifluatex\else
  \ixbaz@error{LuaTeX is required}
   {Package loading is aborted right now.}
\expandafter\endinput\fi\relax
\ifnum\luatexversion<65
  \ixbaz@error{This LuaTeX is too old}
   {This package requires LuaTeX v0.65 or higher.\MessageBreak
    Package loading is aborted right now.}
\expandafter\endinput\fi\relax
% prerequisite packages
\RequirePackage{etoolbox}
\RequirePackage{luatexbase-modutils}
% load accompanying Lua module
\RequireLuaModule{ixbase-core}
% resets codes
\edef\ixbaz@restore@codes{%
  \endlinechar=\the\endlinechar
\relax}
\endlinechar=-1 %

%------------------- helpers

%% \ixbaz@ltr
% \ixbaz@ltr\* (where * is an arbitrary non-letter) expands
% to the letter *.
\def\ixbaz@ltr{\expandafter\@gobble\string}

%% some unique tokens
\protected\def\ixbaz@stop{\ixbaz@stop@}
\protected\def\ixbaz@end{\ixbaz@end@}

%------------------- quick-escape

%%<*> \qesc
% Does the following conversion ('quick-escape');
% here it is assumed \? equals \qesc, 'a' denotes a letter
% or digit, '*' denotes any other character.
% (1) \?\*    -->  *
% (2) \?a     -->  \a                    [#] conversion
% (3) \?*     -->  (* with [#] applied)  from:  + / | - ( ) *
% (4) \??     -->  (print \ and do \?)     to:  # % \ ~ { } ^
\def\qesc#1{\csname ixbaz@?/\string#1\endcsname}
\begingroup
\def\ixbaz@foreachchar#1#2#3{\@tempcnta=#1
  \loop\lccode`\?=\@tempcnta \lowercase{#3?}
  \advance\@tempcnta\@ne \ifnum\@tempcnta<#2\repeat}
\edef\ixbaz@ltrbs{\ixbaz@ltr\\}
\def\ixbaz@define#1{\expandafter\xdef\csname ixbaz@?/#1\endcsname}
\def\ixbaz@do@s#1{\ixbaz@define{\ixbaz@ltrbs#1}{#1}\ixbaz@define{#1}{#1}}
\def\ixbaz@do@l#1{\ixbaz@define{#1}{\ixbaz@ltrbs#1}}
\ixbaz@foreachchar{33}{65}\ixbaz@do@s
\ixbaz@foreachchar{91}{97}\ixbaz@do@s
\ixbaz@foreachchar{123}{127}\ixbaz@do@s
\ixbaz@foreachchar{48}{58}\ixbaz@do@l
\ixbaz@foreachchar{97}{123}\ixbaz@do@l
\def\do#1#2{\ixbaz@define{#1}{\ixbaz@ltr#2}}
\do+\#\do/\%\do|\\\do-\~\do(\{\do)\}\do*\^
\ixbaz@define{?}{\ixbaz@ltrbs\noexpand\qesc}
\endgroup

%%<*> \usebacktickescape
% Makes <`> act as \qesc.
%%<*> \nousebacktickescape
% Revokies \usebacktickescape.
%%<*> \usequestionescape
% Makes <\?> act as \qesc.
%%<*> \nousequestionescape
% Revokies \usebacktickescape.
\begingroup
\catcode96=13 %
\protected\gdef\usebacktickescape{
  \ixbaz@use@escape{`}
   \ixbaz@use@backtick \ixbaz@org@backtick
   {\chardef\ixbaz@cc@backtick=\catcode96 }
  \catcode96=13 %
}
\protected\gdef\nousebacktickescape{
  \ixbaz@disuse@escape{`}
   \ixbaz@use@backtick \ixbaz@org@backtick
   {\catcode96=\ixbaz@cc@backtick}
}
\protected\gdef\usequestionescape{
  \ixbaz@use@escape{\?}
   \ixbaz@use@question \ixbaz@org@question{}
}
\protected\gdef\nousequestionescape{
  \ixbaz@disuse@escape{\?}
   \ixbaz@use@question \ixbaz@org@question{}
}
\endgroup
\def\ixbaz@use@escape#1#2#3#4{
  \ifnum 0=#2
    \let#3#1\let#1\qesc#4
  \fi
  \chardef#2=1 %
}
\def\ixbaz@disuse@escape#1#2#3#4{
  \ifnum 1=#2
    \let#1#3#4
  \fi
  \chardef#2=0 %
}
% initial settings
\chardef\ixbaz@use@backtick=0 %
\chardef\ixbaz@use@question=0 %

%------------------- miscellaneous

%%<*> \luaescape{<text>}
\newcommand\luaescape{} % collision check
\let\luaescape\luatexluaescapestring
%%<*> \luaescapeO{<text>} / \luaescapeN{<text>}
\newcommand\luaescapeO[1]{
  \luatexluaescapestring{\unexpanded\expandafter{#1}}
}
\newcommand\luaescapeN[1]{
  \luatexluaescapestring{\unexpanded{#1}}
}

%%<*> \luanumber{<text>}
\newcommand\luanumber[1]{
  tonumber("\luatexluaescapestring{\detokenize{#1}}")
}

%%<*> \luacoutnerval{<counter>}
\newcommand\luacounterval[1]{
  (\expandafter\number\csname c@#1\endcsname)
}

%%<*> \luacoutnerval{<counter>}
\newcommand\lualengthval[1]{
  (ixbase.to_skip("\the#1"))
}

%--------------------------------------- done
\ixbaz@restore@codes
\endinput
%% EOF
